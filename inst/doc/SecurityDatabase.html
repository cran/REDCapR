<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Security Database</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Security Database</h1>



<div id="description" class="section level1">
<h1>Description</h1>
<p>The SQL code below adds schemas, a table and two stored procedures to
an existing Microsoft SQL Server database. This second database is not
essential to calling the REDCap API, but it helps manage tokens
securely.</p>
<p>This database contains the tokens and other sensitive content (such
as passwords, API tokens, and file paths) that should not be stored in a
Git repository (even a private Git repository). These passwords can be
retrieved by <code>REDCapR::retrieve_credential_mssql()</code>.</p>
</div>
<div id="create-a-dsn-on-each-client" class="section level1">
<h1>Create a DSN on each client</h1>
<p>After executing the SQL code in an existing database, create an ODBC
<a href="https://en.wikipedia.org/wiki/Data_source_name">DSN</a> on
<em>each</em> client machine that calls the database. Download the most
recent drivers (as of Aug 2018, the <a href="https://learn.microsoft.com/en-us/sql/connect/odbc/download-odbc-driver-for-sql-server">most
recent version is 17</a> for Windows and Linux), then run the wizard.
Many values in the wizard will remain at the default values. Here are
the important ones to change.</p>
<ol style="list-style-type: decimal">
<li>Set the DSN’s <code>name</code> field to whatever is used in the
repository’s R code.</li>
<li>Set the authenticity method to
<code>Integrated Windows authentication</code>.</li>
<li>Set the <code>default database</code> to the name of the database
that containing the tokens</li>
</ol>
<p>In our code below, both DSN and database are named
<code>auxiliary_security</code>.</p>
</div>
<div id="note" class="section level1">
<h1>Note</h1>
<p>We use Microsoft SQL Server, because that fits our university’s
infrastructure most easily. But this approach theoretically can work
with any LDAP-enabled database server. Please contact us if your
institution is using something other than SQL Server (or a different
configuration of these components), and would like help adapting this
approach.</p>
</div>
<div id="create-database" class="section level1">
<h1>Create Database</h1>
<p>This SQL code is run once inside an existing database to establish
the schemas, table, and stored procedure used by
<code>REDCapR::retrieve_credential_mssql()</code>. In this example,
we’ve arbitrarily called the database
<code>auxiliary_security</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co">------- SQL code to create necessary components in a Microsoft SQL Sever database -------</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="co">-----------------------------------------------------------------------</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="co">-- Create two schemas.</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="co">-- The first schema is accessible by all REDCap API users.</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="co">-- The second schema is restricted to administrators.</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">SCHEMA</span> [redcap]</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">SCHEMA</span> [redcap_private]</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>GO</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="co">-----------------------------------------------------------------------</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="co">-- Create a table to contain the token</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> redcap_private.tbl_credential (</span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>  <span class="kw">id</span>            <span class="dt">smallint</span>        <span class="kw">primary</span> <span class="kw">key</span>,</span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>  username      <span class="dt">varchar</span>(<span class="dv">30</span>)     <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>  project_id    <span class="dt">smallint</span>        <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>  <span class="kw">instance</span>      <span class="dt">varchar</span>(<span class="dv">30</span>)     <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>  token         <span class="dt">char</span>(<span class="dv">32</span>)        <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>  redcap_uri    <span class="dt">varchar</span>(<span class="dv">255</span>)    <span class="kw">not</span> <span class="kw">null</span></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>)</span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">UNIQUE</span> NONCLUSTERED <span class="kw">INDEX</span> IX_tbl_credential_unique <span class="kw">ON</span> redcap_private.tbl_credential (</span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a>  <span class="kw">instance</span>        <span class="kw">asc</span>,</span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a>  project_id      <span class="kw">asc</span>,</span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a>  username        <span class="kw">asc</span></span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a>)</span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a><span class="co">-----------------------------------------------------------------------</span></span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a><span class="co">-- Create a stored procedure for users to call to retrieve the token.</span></span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a><span class="co">-- Notice it should a different (and more permissive) schema than the table.</span></span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> redcap.prc_credential</span>
<span id="cb1-34"><a href="#cb1-34" tabindex="-1"></a>  @project_id <span class="dt">smallint</span>,</span>
<span id="cb1-35"><a href="#cb1-35" tabindex="-1"></a>  @instance   <span class="dt">varchar</span>(<span class="dv">30</span>)</span>
<span id="cb1-36"><a href="#cb1-36" tabindex="-1"></a><span class="kw">AS</span></span>
<span id="cb1-37"><a href="#cb1-37" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb1-38"><a href="#cb1-38" tabindex="-1"></a>  <span class="kw">SET</span> NOCOUNT <span class="kw">ON</span>;</span>
<span id="cb1-39"><a href="#cb1-39" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" tabindex="-1"></a>  <span class="kw">SELECT</span> username, project_id, token, redcap_uri <span class="kw">FROM</span> redcap_private.tbl_credential</span>
<span id="cb1-41"><a href="#cb1-41" tabindex="-1"></a>  <span class="kw">WHERE</span></span>
<span id="cb1-42"><a href="#cb1-42" tabindex="-1"></a>    username   <span class="op">=</span> system_user <span class="co">-- The username from the server&#39;s OS.</span></span>
<span id="cb1-43"><a href="#cb1-43" tabindex="-1"></a>    <span class="kw">AND</span></span>
<span id="cb1-44"><a href="#cb1-44" tabindex="-1"></a>    project_id <span class="op">=</span> @project_id <span class="co">-- Restricts to the desired REDCap project.</span></span>
<span id="cb1-45"><a href="#cb1-45" tabindex="-1"></a>    <span class="kw">AND</span></span>
<span id="cb1-46"><a href="#cb1-46" tabindex="-1"></a>    <span class="kw">instance</span>   <span class="op">=</span> @instance   <span class="co">-- System accommodates multiple REDCap instances.</span></span>
<span id="cb1-47"><a href="#cb1-47" tabindex="-1"></a><span class="cf">END</span></span></code></pre></div>
</div>
<div id="create-user-credentials-to-the-auxiliary-database" class="section level1">
<h1>Create user credentials to the auxiliary database</h1>
<p>Add a user’s LDAP account to the <code>auxiliary_security</code>
database so that they can query the tables to retrieve their API.</p>
<p>Notice that this only gives the permissions to retrieve the token.
You still must grant them API privileges to each appropriate REDCap
project. The automation in the R file below will copy the API token from
the MySQL database into the <code>auxiliary_security</code> database
(see the ‘Transfer Credentials’ section).</p>
<p>Only database admins should have authorization for the
‘redcap_private’ schema. Typical users should not be authorized for this
schema. The current system allows typical users to view only their own
tokens.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co">-----------------------------------------------------------------------</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="co">-- Add a user account to the auxiliary_security database so that they can query the tables to retrieve their API.</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="co">-- Notice that this only gives the permissions to retrieve the token.  You must still:</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co">--   1) grant them API privileges to each appropriate REDCap project, and</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co">--   2) copy the API from the REDCap database into the  auxiliary_security database.</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="co">-- Also, do not give typical users authorization for the &#39;redcap_private&#39; schema.  The current system allows them to view only their own tokens.</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="co">-----------------------------------------------------------------------</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="co">-- STEP #1: Declare the user name.  If everything runs correctly, this should be the only piece of code that you need to modify.</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>print <span class="st">&#39;Step #1 executing....&#39;</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="kw">USE</span> [<span class="kw">master</span>]</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>GO</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a><span class="kw">DECLARE</span> @qualified_user_name <span class="dt">varchar</span>(<span class="dv">255</span>); <span class="kw">SET</span> @qualified_user_name <span class="op">=</span> <span class="st">&#39;[OUHSC\lsuarez3]&#39;</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>print <span class="st">&#39;Resulting login name: &#39;</span> <span class="op">+</span> @qualified_user_name; print <span class="st">&#39;&#39;</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a><span class="co">--EXEC sp_helplogins @LoginNamePattern=@qualified_user_name</span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a><span class="co">--SELECT * FROM master..syslogins WHERE name = @qualified_user_name</span></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a><span class="co">--SELECT * FROM auxiliary_security.sys.sysusers</span></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a><span class="co">--SELECT * FROM sys.database_permissions</span></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a><span class="co">--SELECT * FROM sys.server_principals</span></span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a><span class="co">-----------------------------------------------------------------------</span></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a><span class="co">-- STEP #2: Create a login for the *server*.</span></span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>print <span class="st">&#39;Step #2 executing....&#39;</span></span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a><span class="kw">DECLARE</span> @sql_create_login <span class="dt">nvarchar</span>(<span class="fu">max</span>)</span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a><span class="kw">SET</span> @sql_create_login <span class="op">=</span> <span class="st">&#39;CREATE LOGIN &#39;</span> <span class="op">+</span> @qualified_user_name <span class="op">+</span> <span class="st">&#39; FROM WINDOWS WITH DEFAULT_DATABASE=[auxiliary_security]&#39;</span></span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a><span class="kw">EXECUTE</span> sp_executesql @sql_create_login</span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a><span class="kw">DECLARE</span> @login_count <span class="kw">AS</span> <span class="dt">INT</span>; <span class="kw">SET</span> @login_count <span class="op">=</span> (<span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> login_count <span class="kw">FROM</span> <span class="kw">master</span><span class="op">..</span>syslogins <span class="kw">WHERE</span> <span class="st">&#39;[&#39;</span> <span class="op">+</span> loginname <span class="op">+</span> <span class="st">&#39;]&#39;</span> <span class="op">=</span> @qualified_user_name)</span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a>print <span class="st">&#39;Logins matching desired name should equal 1.  It equals: &#39;</span> <span class="op">+</span> <span class="fu">CONVERT</span>(<span class="dt">varchar</span>, @login_count); print <span class="st">&#39;&#39;</span></span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" tabindex="-1"></a><span class="co">-----------------------------------------------------------------------</span></span>
<span id="cb2-32"><a href="#cb2-32" tabindex="-1"></a><span class="co">-- STEP #3: Create a user account for the *database*, after switching the database under focus to auxiliary_security.</span></span>
<span id="cb2-33"><a href="#cb2-33" tabindex="-1"></a>print <span class="st">&#39;Step #3 executing....&#39;</span></span>
<span id="cb2-34"><a href="#cb2-34" tabindex="-1"></a><span class="kw">USE</span> [auxiliary_security]</span>
<span id="cb2-35"><a href="#cb2-35" tabindex="-1"></a><span class="kw">DECLARE</span> @sql_create_user <span class="dt">nvarchar</span>(<span class="fu">max</span>)</span>
<span id="cb2-36"><a href="#cb2-36" tabindex="-1"></a><span class="kw">SET</span> @sql_create_user <span class="op">=</span> <span class="st">&#39;CREATE USER &#39;</span> <span class="op">+</span> @qualified_user_name <span class="op">+</span> <span class="st">&#39; FOR LOGIN &#39;</span> <span class="op">+</span> @qualified_user_name</span>
<span id="cb2-37"><a href="#cb2-37" tabindex="-1"></a><span class="kw">EXECUTE</span> sp_executesql @sql_create_user</span>
<span id="cb2-38"><a href="#cb2-38" tabindex="-1"></a><span class="kw">DECLARE</span> @user_count <span class="kw">AS</span> <span class="dt">INT</span>; <span class="kw">SET</span> @user_count <span class="op">=</span> (<span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> user_count <span class="kw">FROM</span> auxiliary_security.sys.sysusers <span class="kw">WHERE</span> <span class="st">&#39;[&#39;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&#39;]&#39;</span> <span class="op">=</span> @qualified_user_name)</span>
<span id="cb2-39"><a href="#cb2-39" tabindex="-1"></a>print <span class="st">&#39;User accounts matching desired name should equal 1.  It equals: &#39;</span> <span class="op">+</span> <span class="fu">CONVERT</span>(<span class="dt">varchar</span>, @user_count); print <span class="st">&#39;&#39;</span></span>
<span id="cb2-40"><a href="#cb2-40" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" tabindex="-1"></a><span class="co">-----------------------------------------------------------------------</span></span>
<span id="cb2-42"><a href="#cb2-42" tabindex="-1"></a><span class="co">-- STEP #4: Grant appropriate privileges for the &#39;redcap&#39; schema.</span></span>
<span id="cb2-43"><a href="#cb2-43" tabindex="-1"></a>print <span class="st">&#39;Step #4 executing....&#39;</span></span>
<span id="cb2-44"><a href="#cb2-44" tabindex="-1"></a><span class="kw">DECLARE</span> @sql_grant_schema_redcap <span class="dt">nvarchar</span>(<span class="fu">max</span>)</span>
<span id="cb2-45"><a href="#cb2-45" tabindex="-1"></a><span class="kw">SET</span> @sql_grant_schema_redcap <span class="op">=</span> <span class="st">&#39;GRANT EXECUTE ON SCHEMA::[redcap] TO &#39;</span> <span class="op">+</span> @qualified_user_name</span>
<span id="cb2-46"><a href="#cb2-46" tabindex="-1"></a><span class="kw">EXECUTE</span> sp_executesql @sql_grant_schema_redcap</span>
<span id="cb2-47"><a href="#cb2-47" tabindex="-1"></a>print <span class="st">&#39;Step #4 executed&#39;</span>; print <span class="st">&#39;&#39;</span></span>
<span id="cb2-48"><a href="#cb2-48" tabindex="-1"></a></span>
<span id="cb2-49"><a href="#cb2-49" tabindex="-1"></a><span class="co">-----------------------------------------------------------------------</span></span>
<span id="cb2-50"><a href="#cb2-50" tabindex="-1"></a><span class="co">-- STEP #5: Grant appropriate privileges for the &#39;Security&#39; schema.</span></span>
<span id="cb2-51"><a href="#cb2-51" tabindex="-1"></a>print <span class="st">&#39;Step #5 executing....&#39;</span></span>
<span id="cb2-52"><a href="#cb2-52" tabindex="-1"></a><span class="kw">DECLARE</span> @sql_grant_schema_security <span class="dt">nvarchar</span>(<span class="fu">max</span>)</span>
<span id="cb2-53"><a href="#cb2-53" tabindex="-1"></a><span class="kw">SET</span> @sql_grant_schema_security <span class="op">=</span> <span class="st">&#39;GRANT EXECUTE ON SCHEMA::[security] TO &#39;</span> <span class="op">+</span> @qualified_user_name</span>
<span id="cb2-54"><a href="#cb2-54" tabindex="-1"></a><span class="kw">EXECUTE</span> sp_executesql @sql_grant_schema_security</span>
<span id="cb2-55"><a href="#cb2-55" tabindex="-1"></a>print <span class="st">&#39;Step #5 executed&#39;</span>; print <span class="st">&#39;&#39;</span></span>
<span id="cb2-56"><a href="#cb2-56" tabindex="-1"></a></span>
<span id="cb2-57"><a href="#cb2-57" tabindex="-1"></a><span class="co">-----------------------------------------------------------------------</span></span>
<span id="cb2-58"><a href="#cb2-58" tabindex="-1"></a><span class="co">-- OPTIONAL STEP: Delete the user from the database (the first line) and then the server (the second line).</span></span>
<span id="cb2-59"><a href="#cb2-59" tabindex="-1"></a><span class="co">-- The person&#39;s other database user accounts (besides with the auxiliary_security database) will NOT be automatically deleted by these two lines.</span></span>
<span id="cb2-60"><a href="#cb2-60" tabindex="-1"></a><span class="co">--USE [auxiliary_security]; DROP USER [OUHSC\lsuarez3]</span></span>
<span id="cb2-61"><a href="#cb2-61" tabindex="-1"></a><span class="co">--USE [master]; DROP LOGIN [OUHSC\lsuarez3]</span></span>
<span id="cb2-62"><a href="#cb2-62" tabindex="-1"></a></span>
<span id="cb2-63"><a href="#cb2-63" tabindex="-1"></a><span class="co">-----------------------------------------------------------------------</span></span>
<span id="cb2-64"><a href="#cb2-64" tabindex="-1"></a><span class="co">-- REFERENCES &amp; NOTES</span></span>
<span id="cb2-65"><a href="#cb2-65" tabindex="-1"></a>  <span class="co">--The @qualified_user_name must have both (a) the &#39;OUHSC&#39; domain qualification, and (b) the square brackets (to escape the backslash).</span></span>
<span id="cb2-66"><a href="#cb2-66" tabindex="-1"></a>  <span class="co">--Using sp_executesql to add users: https://www.sqlservercentral.com/Forums/Topic497615-359-1.aspx</span></span>
<span id="cb2-67"><a href="#cb2-67" tabindex="-1"></a>  <span class="co">--Check if a server login exists: https://stackoverflow.com/questions/37275/sql-query-for-logins</span></span>
<span id="cb2-68"><a href="#cb2-68" tabindex="-1"></a>  <span class="co">--Retrieve database users: https://stackoverflow.com/questions/2445444/how-to-get-a-list-of-users-for-all-instances-databases</span></span>
<span id="cb2-69"><a href="#cb2-69" tabindex="-1"></a>  <span class="co">--Concatenating strings: https://blog.sqlauthority.com/2010/11/25/sql-server-concat-function-in-sql-server-sql-concatenation/</span></span>
<span id="cb2-70"><a href="#cb2-70" tabindex="-1"></a>  <span class="co">--DROP USER from database: https://msdn.microsoft.com/en-us/library/ms189438.aspx</span></span>
<span id="cb2-71"><a href="#cb2-71" tabindex="-1"></a>  <span class="co">--DROP LOGIN from server: https://msdn.microsoft.com/en-us/library/ms188012.aspx</span></span>
<span id="cb2-72"><a href="#cb2-72" tabindex="-1"></a>  <span class="co">--Declaring variables (eg, the username above): https://technet.microsoft.com/en-us/library/aa258839.aspx</span></span>
<span id="cb2-73"><a href="#cb2-73" tabindex="-1"></a>  <span class="co">--A different (&amp; non-dynamic) way to establish a user: https://pic.dhe.ibm.com/infocenter/dmndhelp/v8r5m0/index.jsp?topic=%2Fcom.ibm.wbpm.imuc.sbpm.doc%2Ftopics%2Fdb_create_users_nd_aix.html</span></span>
<span id="cb2-74"><a href="#cb2-74" tabindex="-1"></a>  <span class="co">--If the variable has to cross a &#39;GO&#39; (which the current version of the script doesn&#39;t need): https://stackoverflow.com/questions/937336/is-there-a-way-to-persist-a-variable-across-a-go</span></span></code></pre></div>
</div>
<div id="transfer-credentials" class="section level1">
<h1>Transfer Credentials</h1>
<p>Manually transferring tokens to the auxiliary server becomes
unmanageable as your institution’s collection of API users grows. This
script demonstrates how to programmatically transfer all tokens from
multiple REDCap instances. The basic steps are:</p>
<ol style="list-style-type: decimal">
<li>Read from the MySQL database(s) underneath each REDCap instance on
your campus.</li>
<li>Combine &amp; groom the credentials.</li>
<li>Upload to SQL Server (called <code>auxiliary_security</code>
here).</li>
</ol>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>(<span class="at">all=</span><span class="cn">TRUE</span>)) <span class="co">#Clear the memory for any variables set from any previous runs.</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co"># ---- load-sources ------------------------------------------------------------</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co"># ---- load-packages -----------------------------------------------------------</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(OuhscMunge))</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">&#39;The `OuhscMunge` package needs to be installed with `remotes::install_github(&quot;OuhscBbmc/OuhscMunge&quot;)`.&#39;</span>)</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>testit<span class="sc">::</span><span class="fu">assert</span>(</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>  <span class="st">&quot;The `OuhscMunge` package should meet a minimal version.&quot;</span>,</span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>  <span class="fu">compareVersion</span>( <span class="fu">as.character</span>(<span class="fu">packageVersion</span>(<span class="st">&quot;OuhscMunge&quot;</span>)), <span class="st">&quot;0.1.9.9009&quot;</span>) <span class="sc">&gt;=</span> <span class="dv">0</span><span class="dt">L</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>)</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a><span class="fu">requireNamespace</span>(<span class="st">&quot;DBI&quot;</span>)</span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="fu">requireNamespace</span>(<span class="st">&quot;odbc&quot;</span>)</span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a><span class="fu">requireNamespace</span>(<span class="st">&quot;dplyr&quot;</span>)</span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="fu">requireNamespace</span>(<span class="st">&quot;readr&quot;</span>)</span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a><span class="fu">requireNamespace</span>(<span class="st">&quot;tibble&quot;</span>)</span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a><span class="fu">requireNamespace</span>(<span class="st">&quot;testit&quot;</span>)</span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a><span class="fu">requireNamespace</span>(<span class="st">&quot;checkmate&quot;</span>)</span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a><span class="fu">requireNamespace</span>(<span class="st">&quot;OuhscMunge&quot;</span>)  <span class="co"># remotes::install_github(&quot;OuhscBbmc/OuhscMunge&quot;)</span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a><span class="co"># ---- declare-globals ---------------------------------------------------------</span></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a><span class="co"># This file assume your campus has two REDCap instances.</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a><span class="co"># Modify each (a) database name, (b) REDCap URL, and (c) DSN name.</span></span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>name_production <span class="ot">&lt;-</span> <span class="st">&quot;production&quot;</span></span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>name_dev        <span class="ot">&lt;-</span> <span class="st">&quot;dev&quot;</span></span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>uri_production  <span class="ot">&lt;-</span> <span class="st">&quot;https://redcap-production.ouhsc.edu/redcap/api/&quot;</span>,</span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a>uri_dev         <span class="ot">&lt;-</span> <span class="st">&quot;https://redcap-dev.ouhsc.edu/redcap/api/&quot;</span></span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a>dsn_production  <span class="ot">&lt;-</span> <span class="st">&quot;redcap-production&quot;</span></span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a>dsn_dev         <span class="ot">&lt;-</span> <span class="st">&quot;redcap-dev&quot;</span></span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a>dsn_source      <span class="ot">&lt;-</span> <span class="st">&quot;auxiliary_security&quot;</span> <span class="co"># The DSN of the token server.</span></span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a><span class="co"># The Activity Directory name that should precede each username.</span></span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a><span class="co">#   This should correspond with the result of SQL Server&#39;s `SYSTEM_USER` function</span></span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a><span class="co">#   (https://msdn.microsoft.com/en-us/library/ms179930.aspx)</span></span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a>ldap_prefix <span class="ot">&lt;-</span> <span class="st">&quot;OUHSC</span><span class="sc">\\</span><span class="st">&quot;</span></span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a></span>
<span id="cb3-44"><a href="#cb3-44" tabindex="-1"></a><span class="do">####</span></span>
<span id="cb3-45"><a href="#cb3-45" tabindex="-1"></a><span class="co"># Nothing below this line should need to change, assuming:</span></span>
<span id="cb3-46"><a href="#cb3-46" tabindex="-1"></a><span class="co"># 1. the vignette was followed exactly (https://ouhscbbmc.github.io/REDCapR/articles/SecurityDatabase.html),</span></span>
<span id="cb3-47"><a href="#cb3-47" tabindex="-1"></a><span class="co"># 2. your campus has exactly two REDCap instances.</span></span>
<span id="cb3-48"><a href="#cb3-48" tabindex="-1"></a></span>
<span id="cb3-49"><a href="#cb3-49" tabindex="-1"></a><span class="co"># SQL sent to the MySQL database underneath each REDCap instance.</span></span>
<span id="cb3-50"><a href="#cb3-50" tabindex="-1"></a>sql <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb3-51"><a href="#cb3-51" tabindex="-1"></a><span class="st">  SELECT username, project_id, api_token</span></span>
<span id="cb3-52"><a href="#cb3-52" tabindex="-1"></a><span class="st">  FROM redcap_user_rights</span></span>
<span id="cb3-53"><a href="#cb3-53" tabindex="-1"></a><span class="st">  WHERE api_token IS NOT NULL</span></span>
<span id="cb3-54"><a href="#cb3-54" tabindex="-1"></a><span class="st">&quot;</span></span>
<span id="cb3-55"><a href="#cb3-55" tabindex="-1"></a></span>
<span id="cb3-56"><a href="#cb3-56" tabindex="-1"></a><span class="co"># Update this ad-hoc CSV.  Each row should represent one REDCap instance.</span></span>
<span id="cb3-57"><a href="#cb3-57" tabindex="-1"></a>ds_url <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tribble</span>(</span>
<span id="cb3-58"><a href="#cb3-58" tabindex="-1"></a>  <span class="sc">~</span>instance         , <span class="sc">~</span>redcap_uri,</span>
<span id="cb3-59"><a href="#cb3-59" tabindex="-1"></a>  name_production   , uri_production,</span>
<span id="cb3-60"><a href="#cb3-60" tabindex="-1"></a>  name_dev          , uri_dev</span>
<span id="cb3-61"><a href="#cb3-61" tabindex="-1"></a>)</span>
<span id="cb3-62"><a href="#cb3-62" tabindex="-1"></a></span>
<span id="cb3-63"><a href="#cb3-63" tabindex="-1"></a><span class="co"># Remove variables that aren&#39;t used below.</span></span>
<span id="cb3-64"><a href="#cb3-64" tabindex="-1"></a><span class="fu">rm</span>(uri_production, uri_dev)</span>
<span id="cb3-65"><a href="#cb3-65" tabindex="-1"></a></span>
<span id="cb3-66"><a href="#cb3-66" tabindex="-1"></a></span>
<span id="cb3-67"><a href="#cb3-67" tabindex="-1"></a><span class="co"># ---- load-data ---------------------------------------------------------------</span></span>
<span id="cb3-68"><a href="#cb3-68" tabindex="-1"></a></span>
<span id="cb3-69"><a href="#cb3-69" tabindex="-1"></a><span class="co"># Load the credentials from the first/production REDCap instance.</span></span>
<span id="cb3-70"><a href="#cb3-70" tabindex="-1"></a>cnn_production  <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(odbc<span class="sc">::</span><span class="fu">odbc</span>(), <span class="at">dsn=</span>dsn_production)</span>
<span id="cb3-71"><a href="#cb3-71" tabindex="-1"></a>ds_production   <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(cnn_production, sql)</span>
<span id="cb3-72"><a href="#cb3-72" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(cnn_production); <span class="fu">rm</span>(cnn_production, dsn_production)</span>
<span id="cb3-73"><a href="#cb3-73" tabindex="-1"></a></span>
<span id="cb3-74"><a href="#cb3-74" tabindex="-1"></a><span class="co"># Load the credentials from the second/dev REDCap instance.</span></span>
<span id="cb3-75"><a href="#cb3-75" tabindex="-1"></a>cnn_dev         <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(odbc<span class="sc">::</span><span class="fu">odbc</span>(), <span class="at">dsn=</span>dsn_dev)</span>
<span id="cb3-76"><a href="#cb3-76" tabindex="-1"></a>ds_dev          <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(cnn_dev, sql)</span>
<span id="cb3-77"><a href="#cb3-77" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(cnn_dev); <span class="fu">rm</span>(cnn_dev, dsn_dev)</span>
<span id="cb3-78"><a href="#cb3-78" tabindex="-1"></a></span>
<span id="cb3-79"><a href="#cb3-79" tabindex="-1"></a><span class="fu">rm</span>(sql)</span>
<span id="cb3-80"><a href="#cb3-80" tabindex="-1"></a></span>
<span id="cb3-81"><a href="#cb3-81" tabindex="-1"></a><span class="co"># Assert these are valid datasets and contain at least 5 rows.</span></span>
<span id="cb3-82"><a href="#cb3-82" tabindex="-1"></a><span class="co">#   Adjust &#39;5&#39; to smaller value if necessary.  It&#39;s just to catch blatant retrieval problems.</span></span>
<span id="cb3-83"><a href="#cb3-83" tabindex="-1"></a>checkmate<span class="sc">::</span><span class="fu">assert_data_frame</span>(ds_production, <span class="at">min.rows=</span><span class="dv">5</span>)</span>
<span id="cb3-84"><a href="#cb3-84" tabindex="-1"></a>checkmate<span class="sc">::</span><span class="fu">assert_data_frame</span>(ds_dev       , <span class="at">min.rows=</span><span class="dv">5</span>)</span>
<span id="cb3-85"><a href="#cb3-85" tabindex="-1"></a></span>
<span id="cb3-86"><a href="#cb3-86" tabindex="-1"></a></span>
<span id="cb3-87"><a href="#cb3-87" tabindex="-1"></a><span class="co"># ---- tweak-data --------------------------------------------------------------</span></span>
<span id="cb3-88"><a href="#cb3-88" tabindex="-1"></a></span>
<span id="cb3-89"><a href="#cb3-89" tabindex="-1"></a><span class="co"># Label each instance, so they&#39;re distinguishable later.</span></span>
<span id="cb3-90"><a href="#cb3-90" tabindex="-1"></a>ds_production<span class="sc">$</span>instance <span class="ot">&lt;-</span> name_production</span>
<span id="cb3-91"><a href="#cb3-91" tabindex="-1"></a>ds_dev<span class="sc">$</span>instance        <span class="ot">&lt;-</span> name_dev</span>
<span id="cb3-92"><a href="#cb3-92" tabindex="-1"></a></span>
<span id="cb3-93"><a href="#cb3-93" tabindex="-1"></a><span class="co"># Stack the token collection from each instance.  Then prefix the username and include the URL of each instance.</span></span>
<span id="cb3-94"><a href="#cb3-94" tabindex="-1"></a>ds <span class="ot">&lt;-</span></span>
<span id="cb3-95"><a href="#cb3-95" tabindex="-1"></a>  ds_production <span class="sc">%&gt;%</span></span>
<span id="cb3-96"><a href="#cb3-96" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">union</span>(ds_dev) <span class="sc">%&gt;%</span>                                <span class="co"># Remove union if the dev instance isn&#39;t included.</span></span>
<span id="cb3-97"><a href="#cb3-97" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb3-98"><a href="#cb3-98" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb3-99"><a href="#cb3-99" tabindex="-1"></a>    <span class="at">username        =</span> username,</span>
<span id="cb3-100"><a href="#cb3-100" tabindex="-1"></a>    <span class="at">project_id      =</span> project_id,</span>
<span id="cb3-101"><a href="#cb3-101" tabindex="-1"></a>    <span class="at">instance        =</span> instance,</span>
<span id="cb3-102"><a href="#cb3-102" tabindex="-1"></a>    <span class="at">token           =</span> api_token</span>
<span id="cb3-103"><a href="#cb3-103" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb3-104"><a href="#cb3-104" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb3-105"><a href="#cb3-105" tabindex="-1"></a>    <span class="at">username        =</span> <span class="fu">paste0</span>(ldap_prefix, username), <span class="co"># Qualify for the Active Directory.</span></span>
<span id="cb3-106"><a href="#cb3-106" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb3-107"><a href="#cb3-107" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>( ds_url, <span class="at">by=</span><span class="st">&quot;instance&quot;</span>) <span class="sc">%&gt;%</span>            <span class="co"># Include the instance URL.</span></span>
<span id="cb3-108"><a href="#cb3-108" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(instance, project_id, username) <span class="sc">%&gt;%</span></span>
<span id="cb3-109"><a href="#cb3-109" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">rowid_to_column</span>(<span class="st">&quot;id&quot;</span>)                           <span class="co"># For the sake of a clustered primary key.</span></span>
<span id="cb3-110"><a href="#cb3-110" tabindex="-1"></a></span>
<span id="cb3-111"><a href="#cb3-111" tabindex="-1"></a><span class="fu">rm</span>(ds_production, ds_dev, ds_url)</span>
<span id="cb3-112"><a href="#cb3-112" tabindex="-1"></a><span class="fu">rm</span>(name_production, name_dev)</span>
<span id="cb3-113"><a href="#cb3-113" tabindex="-1"></a><span class="fu">rm</span>(ldap_prefix)</span>
<span id="cb3-114"><a href="#cb3-114" tabindex="-1"></a></span>
<span id="cb3-115"><a href="#cb3-115" tabindex="-1"></a></span>
<span id="cb3-116"><a href="#cb3-116" tabindex="-1"></a><span class="co"># ---- verify-values -----------------------------------------------------------</span></span>
<span id="cb3-117"><a href="#cb3-117" tabindex="-1"></a></span>
<span id="cb3-118"><a href="#cb3-118" tabindex="-1"></a><span class="co"># Assert that the dataset is well-behaved.</span></span>
<span id="cb3-119"><a href="#cb3-119" tabindex="-1"></a><span class="co"># OuhscMunge::verify_value_headstart(ds)</span></span>
<span id="cb3-120"><a href="#cb3-120" tabindex="-1"></a>checkmate<span class="sc">::</span><span class="fu">assert_integer</span>(  ds<span class="sc">$</span>id         , <span class="at">any.missing=</span><span class="cn">FALSE</span>, <span class="at">lower=</span><span class="dv">1</span>, <span class="at">upper=</span>.Machine<span class="sc">$</span>integer.max, <span class="at">unique=</span><span class="cn">TRUE</span>)</span>
<span id="cb3-121"><a href="#cb3-121" tabindex="-1"></a>checkmate<span class="sc">::</span><span class="fu">assert_character</span>(ds<span class="sc">$</span>username   , <span class="at">any.missing=</span><span class="cn">FALSE</span>, <span class="at">pattern=</span><span class="st">&quot;^.{1,255}$&quot;</span>                         )</span>
<span id="cb3-122"><a href="#cb3-122" tabindex="-1"></a>checkmate<span class="sc">::</span><span class="fu">assert_integer</span>(  ds<span class="sc">$</span>project_id , <span class="at">any.missing=</span><span class="cn">FALSE</span>, <span class="at">lower=</span><span class="dv">1</span>, <span class="at">upper=</span>.Machine<span class="sc">$</span>integer.max          )</span>
<span id="cb3-123"><a href="#cb3-123" tabindex="-1"></a>checkmate<span class="sc">::</span><span class="fu">assert_character</span>(ds<span class="sc">$</span>token      , <span class="at">any.missing=</span><span class="cn">FALSE</span>, <span class="at">pattern=</span><span class="st">&quot;^[A-Z0-9]{32}$&quot;</span>           , <span class="at">unique=</span><span class="cn">TRUE</span>)</span>
<span id="cb3-124"><a href="#cb3-124" tabindex="-1"></a>checkmate<span class="sc">::</span><span class="fu">assert_character</span>(ds<span class="sc">$</span>instance   , <span class="at">any.missing=</span><span class="cn">FALSE</span>, <span class="at">pattern=</span><span class="st">&quot;^.{1,255}$&quot;</span>                         )</span>
<span id="cb3-125"><a href="#cb3-125" tabindex="-1"></a>checkmate<span class="sc">::</span><span class="fu">assert_character</span>(ds<span class="sc">$</span>redcap_uri , <span class="at">any.missing=</span><span class="cn">FALSE</span>, <span class="at">pattern=</span><span class="st">&quot;^.{1,255}$&quot;</span>                         )</span>
<span id="cb3-126"><a href="#cb3-126" tabindex="-1"></a></span>
<span id="cb3-127"><a href="#cb3-127" tabindex="-1"></a>testit<span class="sc">::</span><span class="fu">assert</span>(</span>
<span id="cb3-128"><a href="#cb3-128" tabindex="-1"></a>  <span class="st">&quot;The `username` x `project_id` x `instance` must be unique.&quot;</span>,</span>
<span id="cb3-129"><a href="#cb3-129" tabindex="-1"></a>  <span class="fu">sum</span>(<span class="fu">duplicated</span>(<span class="fu">paste0</span>(ds<span class="sc">$</span>username, <span class="st">&quot;-&quot;</span>, ds<span class="sc">$</span>project_id, <span class="st">&quot;-&quot;</span>, ds<span class="sc">$</span>instance))) <span class="sc">==</span> <span class="dv">0</span><span class="dt">L</span></span>
<span id="cb3-130"><a href="#cb3-130" tabindex="-1"></a>)</span>
<span id="cb3-131"><a href="#cb3-131" tabindex="-1"></a></span>
<span id="cb3-132"><a href="#cb3-132" tabindex="-1"></a>testit<span class="sc">::</span><span class="fu">assert</span>(<span class="st">&quot;At least 10 tokens should be ready to write.&quot;</span> , <span class="dv">10</span><span class="dt">L</span> <span class="sc">&lt;=</span> <span class="fu">nrow</span>(ds))</span>
<span id="cb3-133"><a href="#cb3-133" tabindex="-1"></a></span>
<span id="cb3-134"><a href="#cb3-134" tabindex="-1"></a></span>
<span id="cb3-135"><a href="#cb3-135" tabindex="-1"></a><span class="co"># ---- specify-columns-to-upload -----------------------------------------------</span></span>
<span id="cb3-136"><a href="#cb3-136" tabindex="-1"></a></span>
<span id="cb3-137"><a href="#cb3-137" tabindex="-1"></a><span class="co"># Dictate the exact columns and order that will be uploaded.</span></span>
<span id="cb3-138"><a href="#cb3-138" tabindex="-1"></a>columns_to_write <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;username&quot;</span>, <span class="st">&quot;project_id&quot;</span>, <span class="st">&quot;instance&quot;</span>, <span class="st">&quot;token&quot;</span>, <span class="st">&quot;redcap_uri&quot;</span>)</span>
<span id="cb3-139"><a href="#cb3-139" tabindex="-1"></a>ds_slim          <span class="ot">&lt;-</span> ds[, columns_to_write]</span>
<span id="cb3-140"><a href="#cb3-140" tabindex="-1"></a><span class="fu">rm</span>(columns_to_write)</span>
<span id="cb3-141"><a href="#cb3-141" tabindex="-1"></a></span>
<span id="cb3-142"><a href="#cb3-142" tabindex="-1"></a></span>
<span id="cb3-143"><a href="#cb3-143" tabindex="-1"></a><span class="co"># ---- upload-to-db ------------------------------------------------------------------</span></span>
<span id="cb3-144"><a href="#cb3-144" tabindex="-1"></a></span>
<span id="cb3-145"><a href="#cb3-145" tabindex="-1"></a>OuhscMunge<span class="sc">::</span><span class="fu">upload_sqls_odbc</span>(</span>
<span id="cb3-146"><a href="#cb3-146" tabindex="-1"></a>  <span class="at">d               =</span> ds_slim,</span>
<span id="cb3-147"><a href="#cb3-147" tabindex="-1"></a>  <span class="at">schema_name     =</span> <span class="st">&quot;redcap_private&quot;</span>,</span>
<span id="cb3-148"><a href="#cb3-148" tabindex="-1"></a>  <span class="at">table_name      =</span> <span class="st">&quot;tbl_credential&quot;</span>,</span>
<span id="cb3-149"><a href="#cb3-149" tabindex="-1"></a>  <span class="at">dsn_name        =</span> dsn_source,</span>
<span id="cb3-150"><a href="#cb3-150" tabindex="-1"></a>  <span class="at">create_table    =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-151"><a href="#cb3-151" tabindex="-1"></a>  <span class="at">clear_table     =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-152"><a href="#cb3-152" tabindex="-1"></a>  <span class="at">transaction     =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-153"><a href="#cb3-153" tabindex="-1"></a>  <span class="at">verbose         =</span> <span class="cn">TRUE</span></span>
<span id="cb3-154"><a href="#cb3-154" tabindex="-1"></a>)</span>
<span id="cb3-155"><a href="#cb3-155" tabindex="-1"></a><span class="co"># Uploading 252 tokens takes 0.004 minutes.</span></span></code></pre></div>
</div>
<div id="document-info" class="section level1">
<h1>Document Info</h1>
<p>This document is primarily based on REDCap version 8.4.0, and was
last updated 2018-08-10. A development version of the document is
available on GitHub: <a href="https://ouhscbbmc.github.io/REDCapR/articles/SecurityDatabase.html" class="uri">https://ouhscbbmc.github.io/REDCapR/articles/SecurityDatabase.html</a></p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
